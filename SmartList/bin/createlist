#!/bin/sh
: &&O= || exec /bin/sh $0 $argv:q # we're in a csh, feed myself to sh
#########################################################################
#	createlist	To create mailinglists				#
#									#
#	Created by S.R. van den Berg, The Netherlands			#
#########################################################################
#$Id: createlist,v 1.12 1993/01/28 15:18:25 berg Exp $

defaults=.etc

test=test		# /bin/test
ln=ln			# /bin/ln
touch=touch		# /bin/touch
mkdir=mkdir		# /bin/mkdir
sed=sed			# /bin/sed
pwd=pwd			# /bin/pwd
cat=cat			# /bin/cat
rm=rm			# /bin/rm
cp=cp			# /bin/cp
ls=ls			# /bin/ls
chmod=chmod		# /bin/chmod
echo=echo		# /bin/echo
grep=grep		# /bin/grep
lockfile=lockfile	# /usr/local/bin/lockfile

DEVNULL=/dev/null
EX_USAGE=64
EX_UNAVAILABLE=69

( lockfile ) 2>$DEVNULL
if $test $? != 64
then
  echo "Where is \"lockfile\"? It should be installed in your PATH" 1>&2
  exit $EX_UNAVAILABLE
fi

if $test ! -d $defaults
then
  if $test -d list
  then cd ./list
  else cd ..
     $test -d $defaults || cd ..
  fi
fi
if $test ! -d $defaults
then
  echo "createlist: You should be near the main list directory to do this" 1>&2
  exit $EX_USAGE
fi

if $test ! -x .bin/procmail
then
  OIFS="$IFS"
  IFS=:"$IFS"
  procmail=""

  for a in $PATH
  do $test -z "$procmail" -a -x "$a"/procmail && procmail=$a/procmail
  done

  IFS="$OIFS"
  if $test -z "$procmail"
  then
     echo "Where is \"procmail\"?" 1>&2
     echo "The symbolic link .bin/procmail must point to it" 1>&2
     exit $EX_UNAVAILABLE
  fi
  $rm -f .bin/procmail
  $ln -s $procmail .bin/procmail 2>/dev/null ||
  $ln $procmail .bin/procmail 2>/dev/null ||
   ( $cat >.bin/procmail <<HERE
#! /bin/sh
:
exec $procmail "\$@"
HERE
     $chmod 0755 .bin/procmail
   )
fi

domain=`$sed -n -e 's/^[^#]*domain= *\([^	 ]*\).*$/\1/p' \
 $defaults/rc.init`

if $test .$domain = .INSERT.YOUR.MAIL.DOMAIN.HERE
then
  echo "I refuse to do anything useful until you have edited the" 1>&2
  echo "rc.init file.  \`domain' must be set to some sane value." 1>&2
  exit $EX_USAGE
fi

if $test $# != 1 -a $# != 2
then echo "Usage: createlist listname [maintainer]" 1>&2; exit $EX_USAGE
fi

list="$1"
maintainer="$2"

case "$list" in
  "*[/	 ]*") echo "createlist: Suspicious listname specified" 1>&2
     exit $EX_USAGE;;
  *[@!]*) echo "createlist: Specify listname without domain name appended" \
     1>&2; exit $EX_USAGE;;
esac

umask `$sed -n -e 's/^[^#]*UMASK=[^0-9]*\([0-9]*\).*$/\1/p' \
 $defaults/rc.init`

if $mkdir "$list" 2>$DEVNULL
then
:
else echo "createlist: \"$list\" already exists" 1>&2; exit $EX_USAGE
fi
cd "$list"
for a in rc.submit rc.init rc.request help.txt subscribe.txt reject
do
  $cat $DEVNULL >>../$defaults/$a		# to make sure it exists
  $ln ../$defaults/$a $a
done

$mkdir archive
$mkdir archive/latest

$sed -e "/^maintainer/ s/=/=	$maintainer/" <../$defaults/rc.custom \
 >rc.custom
echo "(Only addresses below this line can be automatically removed)" >>dist

$chmod ugo+x .
$chmod ugo+r dist
cd ..

echo 1>&2
echo "Installed the following files (mostly hardlinked):" 1>&2
echo 1>&2
$ls -ld $list $list/* $list/*/* 1>&2
echo 1>&2

listuser=`$ls -ld $defaults | ( read a b user d; echo $user )`

TMPF=.uniq.$$

listdir=$HOME

trap "$rm -f $TMPF" 1 2 3 15

$touch $TMPF
test -f $HOME/$TMPF || listdir=`$pwd`

$rm -f $TMPF
trap 1 2 3 15

flist=$listdir/.bin/flist

echo "Now make the following entries in your /usr/lib/aliases file:" 1>&2
echo \#########################################################################
echo "$list: \"|IFS=' ';exec $flist $list\""
echo "$list-request: \"|IFS=' ';exec $flist $list-request\""
echo "$list-dist: :include:$listdir/$list/dist"
echo \#########################################################################
