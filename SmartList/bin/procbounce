#! /bin/sh
:
# Copyright (c) 1993-1994, S.R. van den Berg, The Netherlands
#$Id: procbounce,v 1.25 1994/05/26 15:06:21 berg Exp $

test=test		# /bin/test
echo=echo		# /bin/echo
cat=cat			# /bin/cat
mkdir=mkdir		# /bin/mkdir
sed=sed			# /bin/sed
ls=ls			# /bin/ls
rm=rm			# /bin/rm
expr=expr		# /bin/expr
date=date		# /bin/date
formail=formail		# /usr/local/bin/formail
multigram=multigram	# ../SedBinDir/multigram
idhash=idhash		# ../SedBinDir/idhash

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.request" && exit 64

tmprequest=tmp.request
dist=dist
bounces=bounces

$test -d $bounces || $mkdir $bounces

addr=`$formail -1 -kdem4 -xSubject: <$tmprequest -s \
 $sed -e '/^[	 *]*Message-[Ii][Dd]:/ d' -e '/^[	 *]*To:/ d' \
  -e 's/^\([^	 ]*\) @ /\1@/' |
 $multigram -b1 -l$off_threshold -x$listaddr -x$listreq $dist `

test -z "$addr" &&
 addr=`$formail -1 -kdem4 -xSubject: <$tmprequest -s \
  $sed -e '/^[	 *]*Message-[Ii][Dd]:/ d' -e '/^[	 *]*To:/ d' |
  $multigram -i -b1 -l16384 -x$domain $dist `

$test -z "$addr" &&
 addr=`$formail -1 +1 -dem4 -XReceived: -uReceived: <$tmprequest -s |
  $multigram -i -b1 -l16384 -x$domain $dist `

if $test ! -z "$addr"
then
  addr=`$expr "X$addr" : 'X.* \([^ ]*\)$' `
  serial=`$formail +1 -1 -m4 -dexMessage-Id: -s $idhash <$tmprequest`
  if $test -z "$serial"
  then
     set dummy `LANG='' $date +%y-%m-%d 2>/dev/null`
     serial=$3$4$2
  fi
  $echo "$addr" >>$bounces/$serial
  $rm -f _dummy_ `$ls -t $bounces/* | $sed -e '1,'$maxhist' d' `

  bounced=0
  for a in $bounces/*
  do
    $test -f "$a" &&
     $echo "From $addr" | $multigram -b1 -l$match_threshold $a >/dev/null &&
     bounced=`$expr $bounced + 1`
  done

  addfield="X-Diagnostic: Mail to $addr bounced $bounced times"
  if $expr $bounced \>= $minbounce >/dev/null
  then
     fieldcontent=`
	if echo "From $addr" |
	 $multigram -b1 -l$auto_off_threshold -d $dist 2>/dev/null
	then
	:
	else
	   $echo 'Not confident enough to autoremove the offending address'
	   $echo "From $addr" | $multigram -b2 -l0 $dist
	fi | $sed -e '/^Removed:/ d' \
	 -e '1 s/^ *[0-9]* \([^ ]* *[0-9]*\).*$/Removed: \1/' \
	  -e 's/^ *[0-9]/	/'`
     $test ! -z "$subscribe_log" &&
      $expr "X$fieldcontent" : 'XRemoved:' >/dev/null &&
      $echo "procbounce: $fieldcontent" >>$subscribe_log
     addfield="$addfield
X-Diagnostic: Bounces exceed threshold of $minbounce
X-Diagnostic: $fieldcontent"
  fi
  $formail -A "$addfield"
else
  $cat
fi
