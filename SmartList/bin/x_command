#! /bin/sh
:
#$Id: x_command,v 1.8 1993/06/07 12:37:03 berg Exp $

echo=echo		# /bin/echo
test=test		# /bin/test
cat=cat			# /bin/cat
formail=formail		# /usr/local/bin/formail
subscribe=subscribe	# ../SedBinDir/subscribe
unsubscribe=unsubscribe # ../SedBinDir/unsubscribe
multigram=multigram	# ../SedBinDir/multigram

tmprequest=tmp.request
tmpfrom=tmp.from
dist=dist
log=log

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.request" && exit 64

X_ENVELOPE_TO=$list-request	# to convince (un)subscribe we used the right
export X_ENVELOPE_TO		# address

$formail -R$X_COMMAND: X-Processed:

while $test $# != 0
do
  case "_$1" in
     _subscribe)
	 $echo="X-Diagnostic: `$echo $2 | $multigram -b1 -l-32767 dist`"
	 $echo "From $2 " >$tmprequest
	 $echo "From: $listreq" >>$tmprequest
	 $echo "Reply-To: $2" >>$tmprequest
	 $echo "To: $listreq" >>$tmprequest
	 $echo "Subject: subscribe $2" >>$tmprequest
	 $echo "$2" >$tmpfrom
	 $test -z "$subscribe_log" ||
	  $echo "x_command: subscribe" >>$subscribe_log
	 $subscribe <$tmprequest | $SENDMAIL $sendmailOPT -t
	 shift ;;
     _unsubscribe)
	 $echo="X-Diagnostic: `$echo $2 | $multigram -b1 -l-32767 dist`"
	 $echo "From $2 " >$tmprequest
	 $echo "From: $listreq" >>$tmprequest
	 $echo "Reply-To: $2" >>$tmprequest
	 $echo "To: $listreq" >>$tmprequest
	 $echo "Subject: unsubscribe $2" >>$tmprequest
	 $echo "$maintainer" "$2" >$tmpfrom
	 $test -z "$subscribe_log" ||
	  $echo "x_command: unsubscribe" >>$subscribe_log
	 $unsubscribe <$tmprequest | $SENDMAIL $sendmailOPT `cat $tmpfrom`
	 shift ;;
     _showdist)
	 $echo "--- Current subscribers:"
	 $cat $dist
	 $echo "--- End of subscriber list" ;;
     _showlog)
	 $echo "--- Current log:"
	 $cat $log
	 $echo "--- End of log" ;;
     _wipelog)
	 $cat /dev/null >$log ;;
     _help|_info)
	 $echo "Known $X_COMMAND keywords:"
	 $echo "	subscribe mailaddress"
	 $echo "	unsubscribe mailaddress"
	 $echo "	showdist"
	 $echo "	showlog"
	 $echo "	wipelog"
	 $echo "	help"
	 $echo "	info" ;;
     _$X_COMMAND_PASSWORD|_$maintainer) ;;
     *) $echo "X-Diagnostic: Unknown command $1" ; set dummy help ;;
  esac
  shift
done
