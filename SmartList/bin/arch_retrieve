#! /bin/sh
:
#$Id: arch_retrieve,v 1.15 1993/05/05 15:15:55 berg Exp $

test=test		# /bin/test
echo=echo		# /bin/echo
ls=ls			# /bin/ls
rm=rm			# /bin/rm
sed=sed			# /bin/sed
cat=cat			# /bin/cat
formail=formail		# /usr/local/bin/formail

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.request" && exit 64

tmprequest=../tmp.request
tmpfrom=../tmp.from

cd archive

from=`$echo "arch_retrieve:" \`$cat $tmpfrom\` requested`
$cat /dev/null >$tmpfrom

case "$X_ENVELOPE_TO" in
  *$list-request*) wrongaddress="" ;;
  *) wrongaddress="WARNING:
	Please try to use '$listreq'
	the next time when issuing archive server requests.
" ;;
esac

$formail -k -xSubject: |
 $sed -e '/^--/,$ d' -e 's/^[	 ]*archive/ARCHIVE/' \
  -e 's/[	 ]archive\/\/*/ /g' |
 (  oldwrongaddress="$wrongaddress"
    wrongaddress="WARNING:
	Please make sure to start the Subject: of requests to the archive-
	server with the word archive.
$wrongaddress"
   sendhelp=""
   ILLEGAL=""
   while read line
   do
      set dummy $line
      shift
      case "$1" in
	 archive|ARCHIVE) shift
	    $test ! -z "$wrongaddress" && wrongaddress="$oldwrongaddress";;
      esac
      case "$1" in
	 send|sendme|get|getme|gimme|retrieve|mail|\
	 SEND|SENDME|GET|GETME|GIMME|RETRIEVE|MAIL)
	    while shift; $test $# != 0
	    do
	       $echo $from "$1" >>$tmpfrom
	       case "$1" in
		  */../*|../*|*/..|..|[-/]*)
		     $test -z "$ILLEGAL" && ILLEGAL="$1";;
		  *)
		   ( $formail -rt -I"Subject: archive retrieval: $1" \
		      -i"From: $listreq" -A"X-Loop: $listaddr" \
		      -I"Precedence: bulk" <$tmprequest
		     $test ! -z "$wrongaddress" && $echo "$wrongaddress" &&
		      wrongaddress=""
		     if $test -f "./$1"
		     then
			$echo "File: $1"
			$echo "BEGIN---------------cut here------------------"
			$cat "./$1"
			$echo "END-----------------cut here------------------"
		     else
			$echo "File $1 is not available."
		     fi
		   ) | $SENDMAIL $sendmailOPT -t ;;
	       esac
	    done ;;
	 ls|dir|directory|list|show|\
	 LS|DIR|DIRECTORY|LIST|SHOW)
	    $test $# = 1 && set dummy .
	    while shift; $test $# != 0
	    do
	       $echo $from "$1" ls >>$tmpfrom
	       case "$1" in
		  */../*|../*|*/..|..|[-/]*)
		     $test -z "$ILLEGAL" && ILLEGAL="$1";;
		  *)
		   ( $formail -rt -I"Subject: archive retrieval: ls $1" \
		      -i"From: $listreq" -A"X-Loop: $listaddr" \
		      -I"Precedence: bulk" <$tmprequest
		     $test ! -z "$wrongaddress" && $echo "$wrongaddress" &&
		      wrongaddress=""
		     if $test -r "./$1"
		     then
			$echo "ls -l $1"
			$echo "BEGIN---------------cut here------------------"
			$ls -lL "./$1" 2>/dev/null || $ls -l "./$1"
			$echo "END-----------------cut here------------------"
		     else
			$echo "File or directory $1 is not available."
		     fi
		   ) | $SENDMAIL $sendmailOPT -t ;;
	       esac
	    done ;;
	 "") ;;
	 *) $test -z "$sendhelp" && sendhelp="$1" ;;
      esac
   done
   if $test ! -z "$sendhelp" -o ! -z "$ILLEGAL"
   then
       ( $formail -rt -I"Subject: archive retrieval error" \
	  -i"From: $listreq" -A"X-Loop: $listaddr" -I"Precedence: bulk" \
	  <$tmprequest
	 $test ! -z "$wrongaddress" && $echo "$wrongaddress" && wrongaddress=""
	 $test ! -z "$sendhelp" && $echo "Unknown command $sendhelp."
	 $test ! -z "$ILLEGAL" && $echo "Illegal filename $ILLEGAL requested."
	 $echo ""
	 $echo "This archive server knows the following commands:"
	 $echo ""
	 $echo "get filename ..."
	 $echo "ls directory ..."
	 $echo ""
	 $echo "Aliases for 'get': send, sendme, getme, gimme, retrieve, mail"
	 $echo "Aliases for 'ls': dir, directory, list, show"
	 $echo ""
	 $echo "Examples:"
	 $echo "ls latest"
	 $echo "get latest/12"
       ) | $SENDMAIL $sendmailOPT -t
   fi
 )

if $test ! -z "$archive_log"
then
  $cat $tmpfrom >>../$archive_log
fi
