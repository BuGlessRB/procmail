#! /bin/sh
:
#$Id: subscribe,v 1.16 1993/06/04 13:49:09 berg Exp $

test=test		# /bin/test
echo=echo		# /bin/echo
cat=cat			# /bin/cat
sed=sed			# /bin/sed
grep=grep		# /bin/grep
formail=formail		# /usr/local/bin/formail
multigram=multigram	# ../SedBinDir/multigram

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.request" && exit 64

tmprequest=tmp.request
tmpfrom=tmp.from
subscribetxt=subscribe.txt

case "$X_ENVELOPE_TO" in
  *$list-request*) wrongaddress="" ;;
  *) wrongaddress="WARNING:
	Please try to use '$listreq'
	the next time when issuing (un)subscribe requests.
" ;;
esac

subscraddr=""

address=`$formail -k -xSubject: |
 $sed -n -e 'y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/' \
  -e 's/add[	 ]*'\
'[^	 ]*[	 ]\([^	 ][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/address[	 ]*'\
'[^	 ]*[	 ]\([^	 ][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/sub[	 ]*'\
'[^	 ]*[	 ]\([^	 ][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/subscribe[	 ]*'\
'[^	 ]*[	 ]\([^	 ][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' `

for a in $address ""
do
  $test -z "$subscraddr" && subscraddr=$a
done

if $test -z "$subscraddr"
then
  address=`$formail -k -xSubject: <$tmprequest |
   $multigram -b1 -x$listreq -x$listaddr -l$off_threshold $tmpfrom |
   $sed -e 's/^ *[^ ]* *[^ ]* *[^ ]* *\([^ ]*\)/\1/' `

  for a in $address ""
  do
     $test -z "$subscraddr" && subscraddr=$a
  done

  $test -z "$subscraddr" && subscraddr=`$cat $tmpfrom`
fi

NOT_METOO=""

$formail -k -xSubject: <$tmprequest |
 $grep 'no.*[^a-z]cop.*[^a-z]please' >/dev/null && NOT_METOO=" (-n)"

$multigram -a "$subscraddr$NOT_METOO" dist >/dev/null

$test -z "$subscribe_log" ||
 $echo "subscribe: $subscraddr by:`$formail -rtxTo: <$tmprequest`" \
 >>$subscribe_log

$formail -i"From: $listreq" -rtA"X-Loop: $listaddr" -I"Precedence: bulk" \
 <$tmprequest

$test ! -z "$wrongaddress" && $echo "$wrongaddress" && wrongaddress=""

$echo "You have added to the subscriber list of:"
$echo
$echo  "	$listaddr"
$echo
$echo "the following mail address:"
$echo
$echo  "	$subscraddr"
$echo
if $test -z "$NOT_METOO"
then
  $echo "By default, copies of your own submissions will be returned."
else
  $echo "As requested, copies of your own submissions will not be returned."
fi
$echo

$cat $subscribetxt

$sed -e 's/^\(.\)/>\1/' $tmprequest
