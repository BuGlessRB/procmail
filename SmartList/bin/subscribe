#! /bin/sh
: &&O= || exec /bin/sh $0 $argv:q # we're in a csh, feed myself to sh
#$Id: subscribe,v 1.10 1993/02/11 14:00:14 berg Exp $

test=test		# /bin/test
echo=echo		# /bin/echo
cat=cat			# /bin/cat
sed=sed			# /bin/sed
grep=grep		# /bin/grep
formail=formail		# /usr/local/bin/formail
multigram=multigram	# ../.bin/multigram

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.request" && exit 64

tmprequest=tmp.request
tmpfrom=tmp.from
subscribetxt=subscribe.txt

case "$X_ENVELOPE_TO" in
  *$list-request*) wrongaddress="" ;;
  *) wrongaddress="
WARNING:
	Please try to use '$listreq'
	the next time when issuing (un)subscribe requests.
" ;;
esac

subscraddr=""

address=`$formail -k -xSubject: |
 $sed -n \
  -e 's/^[	 ]*[aA][dD][dD][	 ]*'\
'[^	 ]*[	 ]\([^		][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/^[	 ]*[aA][dD][dD][rR][eE][sS][sS][	 ]*'\
'[^	 ]*[	 ]\([^		][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/^[	 ]*[sS][uU][bB][	 ]*'\
'[^	 ]*[	 ]\([^		][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' \
  -e 's/^[	 ]*[sS][uU][bB][sS][cC][rR][iI][bB][eE][	 ]*'\
'[^	 ]*[	 ]\([^		][^	 ]*[@!][^	 ][^	 ]*\)/\1/p' `

for a in $address ""
do
  $test -z "$subscraddr" && subscraddr=$a
done

if $test -z "$subscraddr"
then
  address=`$formail -k -xSubject: <$tmprequest |
   $multigram -b1 -l$off_threshold $tmpfrom |
   $sed -e 's/^ *[^ ]* *[^ ]* *[^ ]* *\([^ ]*\)/\1/' `

  for a in $address ""
  do
     $test -z "$subscraddr" && subscraddr=$a
  done

  $test -z "$subscraddr" && subscraddr=`$cat $tmpfrom`
fi

NOT_METOO=""

$formail -k -xSubject: <$tmprequest |
 $grep 'no.*[^a-z]cop.*[^a-z]please' >/dev/null && NOT_METOO=" (-n)"

$multigram -a "$subscraddr$NOT_METOO" dist >/dev/null

$formail -i"From: $listreq" -rtA"X-Loop: $listaddr" -I"Precedence: bulk" \
 <$tmprequest

$test ! -z "$wrongaddress" && $echo "$wrongaddress" && wrongaddress=""

$echo "You have added to the subscriber list of:"
$echo
$echo  "	$listaddr"
$echo
$echo "the following mail address:"
$echo
$echo  "	$subscraddr"
$echo
if $test -z "$NOT_METOO"
then
  $echo "By default, copies of your own submissions will be returned."
else
  $echo "As requested, copies of your own submissions will not be returned."
fi
$echo

$cat $subscribetxt

$sed -e 's/^\(.\)/>\1/' $tmprequest
