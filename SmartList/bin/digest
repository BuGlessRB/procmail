#! /bin/sh
:
#$Id: digest,v 1.4 1993/06/02 15:30:44 berg Exp $

test=test		# /bin/test
echo=echo		# /bin/echo
ls=ls			# /bin/ls
awk=awk			# /usr/bin/awk
cat=cat			# /bin/cat
date=date		# /bin/date
rm=rm			# /bin/rm
sed=sed			# /bin/sed
expr=expr		# /bin/expr
formail=formail		# /usr/local/bin/formail

$test -z "$listaddr" &&
 $echo "Don't start this script directly, it is used in rc.submit" && exit 64

test -z "$foreign_submit$METOO" && exit 1

tmprequest=tmp.request
tmpfrom=tmp.from

digestheader=archive/latest/digest.header
digestadmin=digest.admin
digestadmin2=archive/latest/$digestadmin
digestbody=archive/latest/digest.body
digesttrailer=archive/latest/digest.trailer

$echo "$digest_age $digest_size $archive_hist $UMASK
$SENDMAIL $sendmailOPT $listdist" >.digest.params

$awk '
BEGIN					{ lines=0;mode=0; }
					{ match=0; }
/^$/					{ match=1; }
/^[	 ][	 ]*$/			{ match=2; }
/^------------------------------$/	{ match=3; }
{ if(mode==0)
   { print($0) >"'$tmpfrom'";
     if(match==1)
	mode=1;
     next;
   }
  if(mode==1 && match)
     next;
  mode=2;
  if(match==1)
   { ++lines;next;
   }
  while(lines)
   { print("");--lines;
   }
  if(match==3)
     print(" -----------------------------");
  else
     print($0);
}
END { print("");print("------------------------------");print(""); }
' >$tmprequest

flush_digests -c

for a in Date From To Cc Subject Message-ID Keywords Summary
do
  b="`$formail -X $a: <$tmpfrom`"
  if $test ! -z "$b"
  then
     $echo "$b" >>$digestbody
  fi
done

$echo "" >>$digestbody
$cat $tmprequest >>$digestbody

if $test ! -f $digesttrailer
then

  Year=`$date +%y`
  Issue=0

  if $test -f $digestheader
  then
     set dummy `$sed -n \
      -e '1,/^$/ s/^Subject:.*Digest V\([0-9]*\) #\([0-9]*\)/\1 \2/p' \
      <$digestheader`
     $test $Year = "$2" && Issue=$3
  fi

  Issue=`$expr 1 + $Issue`

  $cat >$digestheader <<HERE
From: $listreq
Reply-To: $undigested_list
Subject: $list Digest V$Year #$Issue
X-Loop: $listaddr
Precedence: list
To: $listaddr

$list Digest				Volume $Year : Issue $Issue

Today's Topics:
HERE

  $echo "End of $list Digest V$Year Issue #$Issue" >$digesttrailer
  b=`$sed -e 's/./*/g' <$digesttrailer`
  $echo "$b" >>$digesttrailer
fi

$echo  "	`$formail -x Subject: <$tmpfrom`" >>$digestheader
$cat /dev/null >$tmprequest 2>$tmpfrom

#
# Check again, maybe we exceed the time or size limits now already.
#

flush_digests -c
exit 0
